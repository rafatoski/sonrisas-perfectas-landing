---
interface Props {
  isCompact?: boolean;
  showHeading?: boolean;
  id?: string;
}

const { isCompact = false, showHeading = true, id = "registro" } = Astro.props;
const WEBHOOK_URL = "https://n8ntest.neuromarkia.online/webhook/registro-paciente";
const WHATSAPP_NUMBER = "573180346087"; // Cambiar por el n√∫mero real de la cl√≠nica
---

<section id={id} class={isCompact ? "" : "py-32 px-4 bg-navy-950 relative overflow-hidden"}>
  {!isCompact && (
    <div class="absolute inset-0 pointer-events-none">
      <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[70%] h-[70%] bg-primary-600/5 rounded-full blur-[120px]"></div>
    </div>
  )}

  <div class={isCompact ? "" : "max-w-xl mx-auto relative z-10"}>
    {showHeading && (
      <div class="text-center mb-16 space-y-4">
        <h2 class="text-4xl md:text-5xl font-black text-white tracking-tight">
          Comienza tu <span class="bg-clip-text text-transparent bg-gradient-to-r from-primary-400 to-indigo-400">Transformaci√≥n</span>
        </h2>
        <p class="text-xl text-gray-400 font-medium">
          Completa el formulario y recibe tu cotizaci√≥n personalizada.
        </p>
      </div>
    )}

    <form id="registroForm" class={`space-y-5 ${isCompact ? 'bg-white p-4' : 'bg-white p-10'} rounded-[1rem] shadow-[0_20px_60px_rgba(0,0,0,0.15)] ring-1 ring-black/5`}>
      {isCompact && (
        <div class="mb-8 space-y-1">
          <h3 class="text-2xl font-black text-black tracking-tight">Agenda tu Valoraci√≥n</h3>
          <p class="text-sm text-black/50 font-medium">Cupos limitados para esta semana</p>
        </div>
      )}
      
      <div class="grid grid-cols-1 gap-5">
        <!-- Nombre -->
        <div class="space-y-1.5">
          <label for="nombre" class="block text-xs font-bold text-black/60 ml-1">
            Nombre completo
          </label>
          <input
            type="text"
            id="nombre"
            name="nombre"
            required
            class="w-full px-5 py-4 bg-gray-50 border border-gray-100 rounded-2xl focus:ring-2 focus:ring-black/10 focus:border-black/20 transition-all outline-none text-black placeholder:text-black/30 font-base bg-white text-gray-900 placeholder:text-gray-400"
            placeholder="Ej: Juan P√©rez"
          />
        </div>

        <!-- Email -->
        <div class="space-y-1.5">
          <label for="email" class="block text-xs font-bold text-black/60 ml-1">
            Correo electr√≥nico
          </label>
          <input
            type="email"
            id="email"
            name="email"
            required
            class="w-full px-5 py-4 bg-gray-50 border border-gray-100 rounded-2xl focus:ring-2 focus:ring-black/10 focus:border-black/20 transition-all outline-none text-black placeholder:text-black/30 font-base bg-white text-gray-900 placeholder:text-gray-400"
            placeholder="tu@email.com"
          />
        </div>

        <!-- WhatsApp -->
        <div class="space-y-1.5">
          <label for="whatsapp" class="block text-xs font-bold text-black/60 ml-1">
            N√∫mero de WhatsApp
          </label>
          <div class="flex group">
            <span class="inline-flex items-center px-4 bg-gray-100 border border-r-0 border-gray-200 rounded-l-2xl text-black/50 text-sm font-base tracking-wider">
              +57
            </span>
            <input
              type="tel"
              id="whatsapp"
              name="whatsapp"
              required
              pattern="[0-9]{10}"
              maxlength="10"
              class="flex-1 px-5 py-4 bg-gray-50 border border-gray-100 rounded-r-2xl focus:ring-2 focus:ring-black/10 focus:border-black/20 transition-all outline-none font-base placeholder:text-black/30 bg-white text-gray-900 placeholder:text-gray-400"
              placeholder="3001234567"
            />
          </div>
        </div>

        <!-- Tratamiento -->
        <div class="space-y-1.5">
          <label for="tratamiento" class="block text-xs font-bold text-black/60 ml-1">
            Tratamiento de inter√©s
          </label>
          <div class="relative">
            <select
              id="tratamiento"
              name="tratamiento"
              required
              class="w-full px-5 py-4 bg-gray-50 border border-gray-100 rounded-2xl focus:ring-2 focus:ring-black/10 focus:border-black/20 transition-all outline-none text-black appearance-none cursor-pointer font-semibold bg-white text-gray-900 placeholder:text-gray-400"
            >
              <option value="" class="bg-white">Selecciona un tratamiento</option>
              <option value="Blanqueamiento dental" class="bg-white">Blanqueamiento dental</option>
              <option value="Ortodoncia invisible" class="bg-white">Ortodoncia invisible</option>
              <option value="Implantes dentales" class="bg-white">Implantes dentales</option>
              <option value="Dise√±o de sonrisa" class="bg-white">Dise√±o de sonrisa</option>
              <option value="Limpieza profunda" class="bg-white">Limpieza profunda</option>
              <option value="Valoraci√≥n general" class="bg-white">Valoraci√≥n general</option>
            </select>
            <div class="absolute inset-y-0 right-4 flex items-center pointer-events-none">
              <svg class="h-4 w-4 text-black/30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </div>
          </div>
        </div>

        <!-- Foto -->
        <div class="space-y-1.5">
          <label for="foto" class="block text-xs font-bold text-black/60 ml-1">
            Foto de tu sonrisa <span class="text-[10px] font-normal opacity-40">(Opcional: JPG o PNG, m√°ximo 1MB)</span>
          </label>
          <div class="relative group cursor-pointer border border-dashed border-gray-200 rounded-2xl p-4 hover:border-black/20 hover:bg-gray-50 transition-all bg-white text-gray-900 placeholder:text-gray-400">
            <input
              id="foto"
              name="foto"
              type="file"
              accept="image/jpeg,image/png,image/jpg"
              class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
            />
            <div class="flex items-center justify-center gap-3">
              <svg class="h-6 w-6 text-black/20 group-hover:text-black/40 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
              </svg>
              <span id="fileName" class="text-xs font-bold text-black/40 truncate group-hover:text-black/60">Subir foto (Opcional)</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Bot√≥n submit -->
      <button
        type="submit"
        id="submitBtn"
        class="group relative w-full bg-sky-500 text-white py-5 px-1 rounded-full font-black  text-base text-start transition-all hover:bg-sky-500 hover:scale-[1.02] active:scale-[0.98] shadow-[0_10px_20px_rgba(2,132,199,0.3)] hover:shadow-[0_0_35px_rgba(2,132,199,0.8)] disabled:opacity-50 disabled:cursor-not-allowed mt-2 overflow-hidden uppercase tracking-widest flex items-center justify-center gap-0"
      >
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
        </svg>
        ¬°QUIERO MI COTIZACI√ìN!
        <div class="absolute inset-0 rounded-full bg-white opacity-0 group-hover:opacity-10 transition-opacity"></div>
      </button>

      <p class="text-[10px] text-center text-black/70 mt-4 font-base leading-relaxed px-4">
        üîí Tus datos est√°n protegidos y solo se usar√°n para tu cotizaci√≥n.
      </p>
    </form>

    <!-- Success Message -->
    <div id="successMessage" class="hidden mt-12 bg-white/[0.03] border border-primary-500/20 rounded-3xl p-12 text-center animate-reveal">
      <div class="mb-8">
        <div class="w-20 h-20 bg-primary-500 rounded-full flex items-center justify-center mx-auto shadow-[0_0_30px_rgba(14,165,233,0.4)]">
          <svg class="h-10 w-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
          </svg>
        </div>
      </div>
      <h3 class="text-3xl font-black text-white mb-4 tracking-tight">¬°Todo listo, <span id="successNombre"></span>!</h3>
      <p class="text-lg text-gray-400 font-medium mb-10">Tu solicitud ha sido procesada con √©xito. Nuestro equipo te contactar√° en breve.</p>
      <a
        id="whatsappBtn"
        href="#"
        target="_blank"
        class="inline-flex items-center gap-3 bg-green-500 text-white py-4 px-10 rounded-full font-black text-lg hover:bg-green-400 transition transform hover:scale-105 shadow-[0_0_25px_rgba(34,197,94,0.3)]"
      >
        Hablar por WhatsApp ahora
      </a>
    </div>

    <!-- Error Message -->
    <div id="errorMessage" class="hidden mt-6 bg-red-500/10 border border-red-500/20 rounded-2xl p-4 text-center">
      <p class="text-red-400 text-sm font-bold">Algo sali√≥ mal. Por favor, intenta de nuevo.</p>
    </div>
  </div>
</section>


<script define:vars={{ WEBHOOK_URL, WHATSAPP_NUMBER }}>
  const form = document.getElementById('registroForm');
  const submitBtn = document.getElementById('submitBtn');
  const successMessage = document.getElementById('successMessage');
  const errorMessage = document.getElementById('errorMessage');
  const fotoInput = document.getElementById('foto');
  const fileName = document.getElementById('fileName');

  fotoInput?.addEventListener('change', (e) => {
    const file = e.target.files?.[0];
    if (file) {
      if (fileName) fileName.textContent = file.name;
      if (file.size > 1048576) { // 1MB
        alert('La imagen es muy pesada. M√°ximo 1MB.');
        fotoInput.value = '';
        if (fileName) fileName.textContent = 'Subir foto (Opcional)';
      }
    }
  });

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="flex items-center justify-center"><svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Procesando...</span>';
    
    try {
      const formData = new FormData(form);
      const nombre = formData.get('nombre');
      const email = formData.get('email');
      const whatsapp = '+57' + formData.get('whatsapp');
      const tratamiento = formData.get('tratamiento');
      const fotoFile = formData.get('foto');

      let base64 = null;
      if (fotoFile && fotoFile.size > 0) {
        // Validar tama√±o por si acaso el change listener fue bypassado
        if (fotoFile.size > 1048576) {
          alert('La imagen es muy pesada. M√°ximo 1MB.');
          submitBtn.disabled = false;
          submitBtn.textContent = '¬°QUIERO MI COTIZACI√ìN!';
          return;
        }

        base64 = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.readAsDataURL(fotoFile);
        });
      }

      await fetch(WEBHOOK_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nombre, email, whatsapp, tratamiento, imagen: base64 })
      });

      form.classList.add('hidden');
      successMessage.classList.remove('hidden');
      document.getElementById('successNombre').textContent = nombre;

      const mensaje = `Hola! Soy ${nombre} y me gustar√≠a recibir una cotizaci√≥n para el tratamiento de ${tratamiento}.`;
      document.getElementById('whatsappBtn').href = `https://api.whatsapp.com/send?phone=${WHATSAPP_NUMBER}&text=${encodeURIComponent(mensaje)}`;
      successMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });

    } catch (error) {
      console.error(error);
      errorMessage.classList.remove('hidden');
      submitBtn.disabled = false;
      submitBtn.textContent = '¬°Quiero mi cotizaci√≥n gratis!';
    }
  });
</script>
